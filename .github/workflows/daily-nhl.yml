name: Daily NHL Data Fetch

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  fetch-nhl:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch and Tailor NHL Data
        run: |
          # Use America/New_York to ensure we fetch games based on EST date
          TODAY=$(TZ="America/New_York" date +%Y-%m-%d)
          
          curl -s "https://api-web.nhle.com/v1/schedule/$TODAY" | jq '{
            games: [
              .gameWeek[].games[] | {
                # Format: YYYY-MM-DD
                date: (.startTimeUTC | fromdateiso8601 - 18000 | strftime("%Y-%m-%d")),
                # Format: THH:MM:SSZ (This matches standard ISO-8601)
                time: ("T" + (.startTimeUTC | fromdateiso8601 - 18000 | strftime("%H:%M:%S")) + "Z"),
                home: .homeTeam.commonName.default,
                visitor: .awayTeam.commonName.default
              }
            ]
          }' > nhl_data.json

      - name: Push NHL file back to GitHub
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Robot"
          git add nhl_data.json
          git commit -m "Automated NHL update (EST): $(date +%Y-%m-%d)" || exit 0
          git push

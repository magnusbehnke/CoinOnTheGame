name: Daily NBA Data Fetch
concurrency: 
  group: git-push-lock
  cancel-in-progress: false

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  fetch-nba:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch and Tailor NBA Data
        run: |
          DATE_QUERY=""
          for i in {0..6}; do
            D=$(date -d "+$i days" +%F)
            DATE_QUERY="${DATE_QUERY}&dates[]=$D"
          done

          curl -H "Authorization: ${{ secrets.NBA_API_KEY }}" \
          "https://api.balldontlie.io/nba/v1/games?${DATE_QUERY}&per_page=100" | \
          jq '{games: [.data[] | {date: .date, time: .status, home: .home_team.full_name, visitor: .visitor_team.full_name}] | sort_by(.date)}' \
          > nba_data.json

          curl -H "Authorization: ${{ secrets.NBA_API_KEY }}" \
          "https://api.balldontlie.io/nba/v1/standings?season=2025" | \
          jq '{standings: [.data[] | {
            team: .team.full_name,
            conference: .conference,
            rank: .conference_rank,
            wins: .wins,
            losses: .losses,
            win_pct: .win_pct
          }] | sort_by(.conference, .rank)}' \
          > nba_standings.json

      - name: Push NBA file back to GitHub
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Robot"
          git add nba_data.json nba_standings.json
          git commit -m "Update NBA scores and standings" || exit 0
          git pull --rebase origin main
          git push
